name: Terraform validation
on:
  workflow_call:
    inputs:
      path:
        required: false
        type: string
        default: "terraform"

env:
  GITHUB_TOKEN: ${{secrets.GITHUB_TOKEN}}

jobs:
  validate-format:
    runs-on: ubuntu-latest
    name: Validate terraform configuration
    steps:
      - name: Git checkout
        uses: nschloe/action-cached-lfs-checkout@v1
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1
      - name: Terraform Format
        id: fmt
        run: terraform -chdir=${{ inputs.path }} fmt -check
      - name: Terraform Init
        id: init
        run: terraform -chdir=${{ inputs.path }} init -input=false -backend=false
      - name: Terraform Validate
        id: validate
        run: terraform -chdir=${{ inputs.path }} validate -no-color

      - name: Comment docs on PR
        uses: NejcZdovc/comment-pr@v1
        if: github.event_name == 'pull_request'
        with:
          identifier: validation
          message: |
            #### Terraform Format and Style üñå`${{ steps.fmt.outcome }}`
            #### Terraform Initialization ‚öôÔ∏è`${{ steps.init.outcome }}`
            #### Terraform Validation ü§ñ`${{ steps.validate.outcome }}`

            <details><summary>Validation Output</summary>

            ```
            ${{ steps.validate.outputs.stdout }}
            ```

            </details>

            *Pusher: @${{ github.actor }}, Action: `${{ github.event_name }}`, Working Directory: `${{ inputs.path }}`, Workflow: `${{ github.workflow }}`*

  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Git checkout
        uses: nschloe/action-cached-lfs-checkout@v1

      - name: Render terraform docs inside the terraformDocs.md
        uses: terraform-docs/gh-actions@v0.11.0
        with:
          working-dir: terraform
          output-file: ../terraformDocs.md
          output-method: inject

      - name: Create TF Docs Pull Request
        uses: peter-evans/create-pull-request@v4.0.4
        if: github.event_name != 'pull_request' && github.ref == 'feature/docs-commit-before-merge'
        with:
          delete-branch: true
          branch: ${{ github.ref }}/tf-docs
          labels: tfdocs
          base: ${{ github.ref }}
          title: Update Terraform docs

      - name: Auto merge TF Docs
        uses: pascalgn/automerge-action@v0.15.3
        env:
          PULL_REQUEST: "${{ steps.cpr.outputs.pull-request-number }}"

      - name: Comment docs on PR
        uses: NejcZdovc/comment-pr@v1
        if: github.event_name == 'pull_request'
        with:
          file: "../../terraformDocs.md"
          identifier: docs